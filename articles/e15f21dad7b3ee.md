---
title: "PlanetScaleã§ã¯`prisma migrate`ã¯ä½¿ã‚ãªã„"
emoji: "ğŸŒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["planetscale", "prisma"]
published: false
---

## TL;DR

## PlanetScaleã¨Prismaã«ã¤ã„ã¦

PlanetScaleã¯ã‚µãƒ¼ãƒãƒ¬ã‚¹DBã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚åˆ©ç”¨æ–™é‡‘ã®ç„¡æ–™æ ã§ã§ãã‚‹ã“ã¨ãŒå……å®Ÿã—ã¦ã„ã‚‹ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãŒé«˜ã„ã€ãªã©ã®ç†ç”±ã§æ³¨ç›®ã‚’é›†ã‚ã¦ã„ã¾ã™ã€‚å€‹äººçš„ã«ã¯ã€å€‹äººé–‹ç™ºã«ãŠã‘ã‚‹ã€ŒRDBã®ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆãŸã„ã€ã€Œã‘ã©ãƒã‚ºã£ãŸã¨ãã‚‚ã¡ã‚ƒã‚“ã¨å¯¾å¿œã—ãŸã„ã€ã¨ã„ã†ä¸å®‰ã‚’è§£æ¶ˆã§ããã†ãªã‚µãƒ¼ãƒ“ã‚¹ã ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

Prismaã¯ã€Node.jsã¨TypeScriptã®ãŸã‚ã®ORMã§ã™ã€‚å®£è¨€çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã€ŒPrisma Migrateã€ã€ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹å‹å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€ŒPrisma Clientã€ãªã©ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚DBã®ãƒ¢ãƒ‡ãƒ«ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¢ãƒ‡ãƒ«ã®å‹ãŒä¸€è‡´ã™ã‚‹ã“ã¨ã§ã€å®‰å…¨ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’TypeScriptã§é–‹ç™ºã™ã‚‹ã®ã§ã‚ã‚Œã°ã€PlanetScaleã¨Prismaã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ã†ã“ã¨ã§ã€éå¸¸ã«è‰¯ã„é–‹ç™ºè€…ä½“é¨“ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€PlanetScaleã¨Prismaã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ã†ã¨ãã®DBã‚¹ã‚­ãƒ¼ãƒã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

## å‰æ

PlanetScaleã¨Prismaã¯ã€ãã‚Œãã‚Œåˆ¥ã®DBã‚¹ã‚­ãƒ¼ãƒã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®ä»•çµ„ã¿ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

### PlanetScaleã®[Branching](https://planetscale.com/docs/concepts/branching)

PlanetScaleã§ã¯ã€ŒBranchingã€ã¨ã„ã†æ©Ÿèƒ½ã‚’ä½¿ã†ã“ã¨ã§ã€gitã®ãƒ–ãƒ©ãƒ³ãƒæ©Ÿèƒ½ã«è¿‘ã„æ„Ÿè¦šã§ã€ã€Œãƒ–ãƒ©ãƒ³ãƒã€ã‚’ä½œã£ã¦DBã‚¹ã‚­ãƒ¼ãƒã‚’åˆ†å²ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æœ¬ç•ªç”¨ã®DBã‚¹ã‚­ãƒ¼ãƒã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€ä»¥ä¸‹ã®æ‰‹é †ã§ä½œæ¥­ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

1. æœ¬ç•ªãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã€Œdevelopment branchã€ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ãƒ–ãƒ©ãƒ³ãƒä¸Šã®DBã¯ã€æœ¬ç•ªDBã¨åŒæ§˜ã®ã‚¹ã‚­ãƒ¼ãƒã‚’æŒã£ãŸåˆ¥ã®DBãªã®ã§ã€è‡ªç”±ã«å¤‰æ›´ã‚’åŠ ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
2. development branchä¸Šã®DBã«å¯¾ã—ã¦ã€ã‚«ãƒ©ãƒ ã®å‰Šé™¤ã‚„ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¿½åŠ ãªã©ã®ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´ã‚’è¡Œã„ã¾ã™ã€‚
3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã‹ã‚‰development branchä¸Šã®DBã‚’æ“ä½œã—ã€å•é¡Œãªãå‹•ä½œã™ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
4. ã€Œdeploy requestã€ã‚’ä½œæˆã—ã¾ã™ã€‚
5. PlanetScaleã¯ã€deploy requestã®é–‹ç™ºã‚¹ã‚­ãƒ¼ãƒã¨æœ¬ç•ªã‚¹ã‚­ãƒ¼ãƒã¨ã‚’æ¯”è¼ƒã—ã¦ã‚¹ã‚­ãƒ¼ãƒå·®åˆ†ã‚’ä½œæˆã—ã¾ã™ã€‚ã‚¹ã‚­ãƒ¼ãƒå·®åˆ†ã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ã©ã®ã‚ˆã†ãªå¤‰æ›´ãŒè¡Œã‚ã‚Œã‚‹ã‹ã€ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ãªè¦æ±‚ã‹ã©ã†ã‹ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ãŒæ¬ è½ã—ã¦ã„ãªã„ã‹ã€ãªã©ã®ã‚¹ã‚­ãƒ¼ãƒã®å•é¡Œç‚¹ãŒãªã„ã‹ã©ã†ã‹ãªã©ï¼‰ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
6. é–‹ç™ºãƒãƒ¼ãƒ ã¯deploy requestã‚’ç¢ºèªã—ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ‰¿èªã—ã¾ã™ã€‚
7. PlanetScaleãŒæ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒã®DBã‚’ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹ã—ã¾ã™ã€‚
8. ã“ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãŒã‚¼ãƒ­ã«ãªã‚‹ã‚ˆã†ãªæ–¹æ³•ã§å®Ÿæ–½ã•ã‚Œã‚‹ãŸã‚ã€ãƒ†ãƒ¼ãƒ–ãƒ«ãŒãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã‚Šã€ç§»è¡Œä¸­ã«æœ¬ç•ªç’°å¢ƒãŒé…ããªã‚‹ãªã©ã®å•é¡ŒãŒèµ·ã“ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```mermaid
sequenceDiagram
  production->>development: development branchã‚’ä½œæˆ
  development->>development: ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´
  development->>development: deploy requestã®ä½œæˆ
  development->>development: ã‚¹ã‚­ãƒ¼ãƒã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ¶ˆ
  development->>development: å‹•ä½œç¢ºèª
  development->>production: ãƒ‡ãƒ—ãƒ­ã‚¤
```

è©³ç´°ã¯[ã“ã¡ã‚‰](https://planetscale.com/docs/concepts/branching)ã€‚

### Prismaã®[Prisma Migrate](https://www.prisma.io/docs/concepts/components/prisma-migrate)

<!-- TODO: https://www.prisma.io/docs/concepts/components/prisma-migrate/mental-model#how-prisma-migrate-tracks-the-migration-state -->

## Prismaã§PlanetScaleã®DBã‚¹ã‚­ãƒ¼ãƒã‚’å¤‰æ›´ã™ã‚‹ã«ã¯

Prisma Migrateã¯ã€DBã‚¹ã‚­ãƒ¼ãƒã®çŠ¶æ…‹ã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã«æ¬¡ã®æƒ…å ±ã‚’ä½¿ã„ã¾ã™

- **prismaã®ã‚¹ã‚­ãƒ¼ãƒ**
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´**
- **`prisma_migrations`ãƒ†ãƒ¼ãƒ–ãƒ«**
- **DBã‚¹ã‚­ãƒ¼ãƒ**

## å‚è€ƒ

<https://planetscale.com/docs/concepts/branching>
