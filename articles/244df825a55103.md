---
title: "Route Handlersã§NextAuth.jsã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå–ã‚Œãªãã¦å›°ã£ãŸ"
emoji: "ğŸª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextauth", "nextjs", "approuter"]
published: true
publication_name: "praha"
---

Next.jsï¼ˆ13.4.5ï¼‰ã‚’ä½¿ã£ã¦å€‹äººé–‹ç™ºã‚’ã—ã¦ã„ã¾ã™ã€‚èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…ã«[NextAuth.js](https://next-auth.js.org/)ï¼ˆ4.22.1ï¼‰ã‚’åˆ©ç”¨ã—ãŸã¨ã“ã‚ã€å›°ã‚ŠãŒã‚ã£ãŸã®ã§ãã®å†…å®¹ã¨è§£æ±ºæ–¹æ³•ã‚’å…±æœ‰ã—ã¾ã™ã€‚ã‚‚ã£ã¨ã„ã„è§£æ±ºæ–¹æ³•ãªã©ã‚ã‚Œã°ã”æŒ‡æ‘˜ãŠé¡˜ã„ã—ã¾ã™ã€‚

## ã“ã¨ã®ãŠã“ã‚Š

ã¾ãšã€[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://next-auth.js.org/configuration/nextjs)ã«ã‚ã‚‹é€šã‚Šã€ã‚‚ã‚ã‚‚ã‚ã®è¨­å®šã‚’è¡Œã„ã¾ã—ãŸã€‚

```typescript:src/libs/next-auth/options.ts
import { PrismaAdapter } from "@next-auth/prisma-adapter";
import GoogleProvider from "next-auth/providers/google";

import client from "@/libs/prisma/client";

import type { NextAuthOptions } from "next-auth";

export const nextAuthOptions: NextAuthOptions = {
  debug: true,
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET,
    }),
  ],
  adapter: PrismaAdapter(client),
  callbacks: {
    session: ({ session, user }) => {
      return {
        ...session,
        user: {
          ...session.user,
          id: user.id,
        },
      };
    },
  },
  secret: process.env.NEXTAUTH_SECRET,
};

```

```typescript:src/app/api/auth/[...nextauth]/route.ts
import NextAuth from "next-auth";

import { nextAuthOptions } from "@/libs/next-auth/options";

const handler = NextAuth(nextAuthOptions);

// https://next-auth.js.org/configuration/initialization#route-handlers-app
export { handler as GET, handler as POST };

```

```tsx:src/libs/next-auth/provider.tsx
"use client";

import { SessionProvider } from "next-auth/react";

import type { FC, PropsWithChildren } from "react";

export const NextAuthProvider: FC<PropsWithChildren> = ({ children }) => {
  return <SessionProvider>{children}</SessionProvider>;
};

```

```tsx:src/app/layout.tsx
import { NextAuthProvider } from "@/libs/next-auth/provider";

import type { FC, PropsWithChildren } from "react";

const RootLayout: FC<PropsWithChildren> = ({ children }) => {
  return (
    <html lang="ja">
      <body>
        <NextAuthProvider>{children}</NextAuthProvider>
      </body>
    </html>
  );
};
export default RootLayout;

```

[prisma-adapterã®è¨­å®š](https://authjs.dev/reference/adapter/prisma)ãªã©ã‚‚è¡Œã„ã¾ã—ãŸãŒã€è¨˜äº‹ã®ä¸»é¡Œã¨ã¯é–¢ä¿‚ãªã„ãŸã‚çœç•¥ã—ã¾ã™ã€‚

[`getServerSession`](https://next-auth.js.org/configuration/nextjs#getserversession)ã‚’ä½¿ç”¨ã—ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹[ãƒ¦ãƒ¼ã‚¶ãƒ¼](https://authjs.dev/reference/adapters#user)ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—ã—ã¦ã¿ã¾ã™ã€‚

```tsx:src/app/page.tsx
import { Suspense } from "react";

import { Container, Heading, Spinner, Stack } from "@/libs/chakra-ui";

import { LogoutButton } from "@/features/auth/logout-button";
import { Name } from "@/features/user/name";

import type { NextPage } from "next";

const Page: NextPage = () => {
  return (
    <Container>
      <Stack direction="column">
        <Heading>ã‚ˆã†ã“ã</Heading>
        <Suspense fallback={<Spinner />}>
          <Name />
        </Suspense>
        <LogoutButton />
      </Stack>
    </Container>
  );
};
export default Page;

```

```tsx:src/features/user/name.tsx
import { getServerSession } from "next-auth";

import { Text } from "@/libs/chakra-ui";
import { nextAuthOptions } from "@/libs/next-auth/options";

import type { FC } from "react";

export const Name: FC = async () => {
  const session = await getServerSession(nextAuthOptions);

  return <Text>{session?.user.name ?? "-"}</Text>;
};

```

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—ã«æˆåŠŸã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ãŸã‚‰ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã€ã¿ãŸã„ãªå‡¦ç†ãŒæ›¸ã‘ãã†ã§ã™ã€‚

[Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/router-handlers)ã§ã‚‚åŒæ§˜ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã€èªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯401ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã¿ãŸã„ãªã“ã¨ã‚’ã—ã¦ã¿ãŸã„ã§ã™ã€‚

```typescript:src/app/api/hello/route.ts
import { getServerSession } from "next-auth/next";
import { NextResponse } from "next/server";

import { nextAuthOptions } from "@/libs/next-auth/options";

export const GET = async (req: Request) => {
  const session = await getServerSession(nextAuthOptions);

  if (!session) {
    return NextResponse.json({ message: "Unauthorized" }, { status: 401 });
  }

  return NextResponse.json({ message: "Hello" }, { status: 200 });
};

```

```tsx:src/features/hello/greet.tsx
import { Text } from "@/libs/chakra-ui";

import type { FC } from "react";

export const Greet: FC = async () => {
  const response = await fetch("http://localhost:3000/api/hello", {
    cache: "no-cache",
  });
  const hello = await response.json();

  return <Text>{JSON.stringify(hello)}</Text>;
};

```

```tsx:src/app/page.tsx
import { Suspense } from "react";

import { Container, Heading, Spinner, Stack } from "@/libs/chakra-ui";

import { LogoutButton } from "@/features/auth/logout-button";
import { Greet } from "@/features/hello/greet";
import { Name } from "@/features/user/name";

import type { NextPage } from "next";

const Page: NextPage = async () => {
  return (
    <Container>
      <Stack direction="column">
        <Heading>ã‚ˆã†ã“ã</Heading>
        <Suspense fallback={<Spinner />}>
          <Name />
        </Suspense>
        <Suspense fallback={<Spinner />}>
          <Greet />
        </Suspense>
        <LogoutButton />
      </Stack>
    </Container>
  );
};
export default Page;

```

`getServerSession`ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå–å¾—ã§ãã‚Œã°ã€`<Greet />`ã¯`{"message":"Hello"}`ã‚’è¿”ã™ã¯ãšã§ã™ã€‚

å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã€`<Greet />`ã¯`{"message":"Hello"}`ã§ã¯ãªã`{"message":"Unauthorized"}`ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚Route Handlerå†…ã®`getServerSession(nextAuthOptions)`ãŒ`null`ã‚’è¿”ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

## ãªãœã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå–ã‚Œãªã‹ã£ãŸã®ã‹

`getServerSession`ãŒã©ã®ã‚ˆã†ã«ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã¦ã„ã‚‹ã®ã‹è¦‹ã¦ã¿ã¾ã™ã€‚

https://github.com/nextauthjs/next-auth/blob/main/packages/next-auth/src/next/index.ts#L166-L234

å¼•æ•°ã®æ•°ãŒ0ã‚‚ã—ãã¯1ã®å ´åˆã¯React Server Componentã§ã®åˆ©ç”¨ã§ã‚ã‚‹ã¨åˆ¤æ–­ã—ã€`const { headers, cookies } = require("next/headers")`ã§`headers`ã¨`cookies`ã‚’å–å¾—ã€‚`headers`ã¨`cookies`ã‚’`AuthHandler`ã«æ¸¡ã—ã€sessionã‚’ä½œã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

`getServerSession`ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã§ãã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã§ãã¦ã„ãªã„Route Handlerã¨ã§ã€`headers`ã¨`cookies`ãŒãã‚Œãã‚Œã©ã®ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã‹è¦‹ã¦ã„ãã¾ã™ã€‚

```tsx:src/features/hello/greet.tsx
import { Text } from "@/libs/chakra-ui";

import type { FC } from "react";

export const Greet: FC = async () => {
  console.log("server component");
  console.log({
    headers: Object.fromEntries(headers()),
    cookies: cookies().getAll(),
  });

  const response = await fetch("http://localhost:3000/api/hello", {
    cache: "no-cache",
  });
  const hello = await response.json();

  return <Text>{JSON.stringify(hello)}</Text>;
};

```

```typescript:src/app/api/hello/route.ts
import { getServerSession } from "next-auth/next";
import { cookies, headers } from "next/headers";
import { NextResponse } from "next/server";

import { nextAuthOptions } from "@/libs/next-auth/options";

export const GET = async (req: Request) => {
  console.log("route handler");
  console.log({
    headers: Object.fromEntries(headers()),
    cookies: cookies().getAll(),
  });
  const session = await getServerSession(nextAuthOptions);

  if (!session) {
    return NextResponse.json({ message: "Unauthorized" }, { status: 401 });
  }

  return NextResponse.json({ message: "Hello" }, { status: 200 });
};

```

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ã¿ã‚‹ã¨ã€cookiesï¼ˆ`next-auth.csrf-token`ã€`next-auth.callback-url`ã€`next-auth.session-token`ï¼‰ãªã©ã®headersãŒã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ–¹ã«ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€Route Handlerã®æ–¹ã«ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚

Route Handlerã§ã¯ã€å¿…è¦ãªheadersãŒè¨­å®šã•ã‚Œã¦ã„ãªã‹ã£ãŸã‹ã‚‰`getServerSession`ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã§ããªã‹ã£ãŸã¨è€ƒãˆã¦ã¿ã¾ã™ã€‚

## ã©ã†è§£æ±ºã—ãŸã‹

ï¼ˆè¡¨ç¾ãŒæ­£ã—ã„ã‹ã©ã†ã‹ã¯è‡ªä¿¡ã‚ã‚Šã¾ã›ã‚“ãŒï¼‰æ¬¡ã®ã‚ˆã†ãªçŠ¶æ…‹ã§ã‚ã‚‹ã¨è€ƒãˆã¾ã—ãŸã€‚

- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰`localhost:3000`ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯å¿…è¦ãªheadersãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- `<Greet />`ã‹ã‚‰`localhost:3000/api/hello`ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯å¿…è¦ãªheadersãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

ãã“ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰`localhost:3000`ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«è¨­å®šã•ã‚Œã¦ã„ã‚‹headersã‚’ã€`<Greet />`ã‹ã‚‰`localhost:3000/api/hello`ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚‚ãã®ã¾ã¾è¨­å®šã—ã¦ã¿ã¾ã™ã€‚

```tsx:src/features/hello/greet.tsx
import { headers } from "next/headers";

import { Text } from "@/libs/chakra-ui";

import type { FC } from "react";

export const Greet: FC = async () => {
  const response = await fetch("http://localhost:3000/api/hello", {
    cache: "no-cache",
    headers: Object.fromEntries(headers()),
  });
  const hello = await response.json();

  return <Text>{JSON.stringify(hello)}</Text>;
};
```

`<Greet />`ãŒ`{"message":"Hello"}`ã‚’è¡¨ç¤ºã—ã€`/api/hello`ã§`getServerSession`ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã§ããŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

## ãŠã‚ã‚Š

ã™ã¹ã¦ã®headersã‚’ã¾ã‚‹ã”ã¨Route Handlerã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä¹—ã›ã¦ã—ã¾ã£ã¦ã„ã‚‹ã®ã§ã€å¿…è¦æœ€ä½é™ã®ã‚‚ã®ã ã‘ä¹—ã›ã‚‹ã‚ˆã†ã«ã—ãŸã»ã†ãŒã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãŸã¨ãˆã°``headers: { Cookie: cookies().getAll().map(({ name, value }) => `${name}=${value}`).join(";") }``ã¨ã‹ã—ã¦cookiesã ã‘è¨­å®šã™ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¦ã‚‚å‹•ãã¾ã—ãŸã€‚
